---
title: "Fama French"
output: html_document
date: "2024-12-08"
---

```{r, warning = FALSE, error=FALSE}
# Load necessary packages
options(xts.warn_dplyr_breaks_lag = FALSE)
library(astsa)       # for sarima
library(tidyverse)
library(quantmod)    # for getting stock data
library(lubridate)   # for date manipulations
library(dplyr)       # for data wrangling
library(tidyr)       # for data manipulation
library(zoo)         # for time series alignment
library(broom)       # for tidy model output
library(lubridate)
library(vars)
```

```{r}
df = read.csv('FF_FiveFactors.csv', header = FALSE)[-c(1,2),]
names(df) = c('date', unlist(df[1,-c(1)]))
df = df[-c(1),]
df$date = as.Date(df$date, format = '%Y%m%d')
df = subset(df, date > '2015-01-01')
df[-1] <- lapply(df[-1], function(x) as.numeric(as.character(x)))

mom = read.csv('momentum.csv', header = FALSE)[-c(1:12),-c(3)]
names(mom) = c('date', 'MOM')
mom$MOM = as.numeric(mom$MOM)
mom$date = as.Date(mom$date, format = '%Y%m%d')
mom = subset(mom, date > '2015-01-01')

df <- merge(df, mom, by = 'date', all.x = TRUE)
```


```{r}
plot_cumulative_returns <- function(df){
df_long <- df %>%
  pivot_longer(cols = c(`Mkt-RF`, SMB, HML, RMW, CMA, MOM, RF), 
               names_to = "factor",
               values_to = "value")

df_cum <- df_long %>%
  group_by(factor) %>%
  arrange(date) %>%
  mutate(cumulative_return = cumprod(1 + (value / 100)) - 1) %>%
  ungroup()

ggplot(df_cum, aes(x = date, y = cumulative_return, color = factor)) +
  geom_line(linewidth = 0.5) +
  labs(title = "Cumulative Factor Returns Over Time",
       x = "Date",
       y = "Cumulative Return") +
  theme_minimal()
}

plot_cumulative_returns(df)
```

```{r}
library(parallel)
get_asset_data <- function(tickers, df, n_cores = detectCores() - 1) {
  # Process Fama-French factors first
  df_weekly <- df %>%
    mutate(date = floor_date(date, "week") + days(5)) %>%  # Changed to days()
    group_by(date) %>%
    summarise(
      `Mkt-RF` = (prod(1 + `Mkt-RF`/100) - 1) * 100,
      SMB      = (prod(1 + SMB/100) - 1) * 100,
      HML      = (prod(1 + HML/100) - 1) * 100,
      RMW      = (prod(1 + RMW/100) - 1) * 100,
      CMA      = (prod(1 + CMA/100) - 1) * 100,
      MOM      = (prod(1 + MOM/100) - 1) * 100,
      RF       = sum(RF)
    ) %>%
    ungroup()
  
  end_date <- max(df_weekly$date)
  start_date <- min(df_weekly$date)
  
  # Process tickers in parallel using mclapply
  all_returns <- mclapply(tickers, function(tick) {
    invisible(getSymbols(tick, from = start_date, to = end_date, auto.assign = TRUE))
    stock_xts <- get(tick)
    daily_prices <- Cl(stock_xts)
    stock_ret <- weeklyReturn(daily_prices, type = "arithmetic") * 100
    stock_ret_dates <- index(stock_ret)
    
    data.frame(
      date = floor_date(stock_ret_dates, "week") + days(5),
      stock = tick,
      return = as.numeric(stock_ret)
    )
  }, mc.cores = n_cores) %>% 
    bind_rows()
  
  # Merge with Fama-French factors and calculate excess returns
  merged_data <- merge(all_returns, df_weekly, by='date', all.x = TRUE) %>%
    mutate(excess_return = return - RF)
  
  return(merged_data)
}
```


```{r}
get_asset_exposures <- function(tickers, dollar_exposures,factor_data, decay_rate) {
  
  merged_data <- get_asset_data(tickers, factor_data)
  
  final_date <- max(merged_data$date)
  merged_data <- merged_data[order(merged_data$date), ]
  
  # Extract unique tickers
  joined_with_value <- mapply(list, tickers, dollar_exposures, SIMPLIFY=F)
  
  # Parallel computation over tickers
  results_list <- lapply(c(1:length(joined_with_value)), function(i) {
    tick = joined_with_value[[i]][[1]]
    
    stock_df <- subset(merged_data, stock == tick & !is.na(excess_return))
    stock_df <- stock_df[order(stock_df$date), ]
    
    # Calculate weights
    stock_df$months_from_end <- as.numeric((final_date - stock_df$date) / 30)
    stock_df$weight <- decay_rate^(stock_df$months_from_end)
    
    # Run weighted regression
    fit <- lm(excess_return ~ `Mkt-RF` + SMB + HML + RMW + CMA + MOM,
              data = stock_df, weights = stock_df$weight)
    # Extract coefficients and apply significance logic
    coefs <- coef(summary(fit))
    alpha <- round(ifelse(coefs["(Intercept)", "Pr(>|t|)"] > 0.05, 0, coefs["(Intercept)", "Estimate"]), 4)
    market <- round(coefs["`Mkt-RF`", "Estimate"], 4)
    size <- round(ifelse(coefs["SMB", "Pr(>|t|)"] > 0.05, 0, coefs["SMB", "Estimate"]), 4)
    value <- round(ifelse(coefs["HML", "Pr(>|t|)"] > 0.05, 0, coefs["HML", "Estimate"]), 4)
    prof <- round(ifelse(coefs["RMW", "Pr(>|t|)"] > 0.05, 0, coefs["RMW", "Estimate"]), 4)
    mom <- round(ifelse(coefs["MOM", "Pr(>|t|)"] > 0.05, 0, coefs["MOM", "Estimate"]), 4)
    invest <- round(ifelse(coefs["CMA", "Pr(>|t|)"] > 0.05, 0, coefs["CMA", "Estimate"]), 4)
    
    # Return the results for this ticker
    data.frame(
      asset = tick,
      alpha = alpha,
      market = market,
      size = size,
      value = value,
      profit = prof,
      investment = invest,
      momentum = mom,
      r2 = round(summary(fit)$r.squared, 4),
      stringsAsFactors = FALSE,
      dollar_exposure = joined_with_value[[i]][[2]]
    )
  })
  
  # Combine all results
  exposures <- do.call(rbind, results_list)
  exposures = exposures[order(-1*exposures$dollar_exposure),]
  rownames(exposures) = c(1:nrow(exposures))
  return(exposures)
}

get_portfolio_exposure <- function(data) {
  factor_cols <- c("alpha", "market", "size", "value", "profit", "investment", "momentum", "r2")
  
  w <- data$dollar_exposure / sum(data$dollar_exposure, na.rm = TRUE)
  
  # Compute the weighted average for each factor column
  weighted_exposures <- round(colSums(data[factor_cols] * w, na.rm = TRUE), 4)
  names(weighted_exposures)[length(weighted_exposures)] = "r2_est"
  return(weighted_exposures)
}
```

```{r}
# tickers <- gsub("\\.", "-", read.csv('constituents.csv')$Symbol)
# tickers <- tickers[tickers != 'AMTM']
# dollar_exposures <- round(runif(length(tickers), 100, 100.0001),2)

tickers <- c("VOO", "VEU", "AVUV", "VB",
             "XBI", "AVEM", "SWYNX", "IAK",
             "BKNG", "GBTC")
dollar_exposures <- c(26300, 7700, 3500, 2500,
                      3500, 3000, 2400, 5000,
                      2500, 15300)

(exposures <- get_asset_exposures(tickers, dollar_exposures,
                                  df, decay_rate = 0.97))
```

```{r}
(portfolio_exposures <- get_portfolio_exposure(exposures))
```


